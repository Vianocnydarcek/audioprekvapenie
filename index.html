<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Je≈æi≈°kov Robo-posol pre Zoe</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --dog: #d1d8e0; --dog-d: #a5b1c2; --dog-shadow: #8e9da5; --acc: #45aaf2; --gold: #f7b731; }
        body {
            font-family: 'Segoe UI', sans-serif; background: #1e272e; color: white; margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; touch-action: none; overflow: hidden;
        }
        .app-container {
            background: rgba(255, 255, 255, 0.98); border-radius: 40px; max-width: 450px; width: 95%; padding: 20px;
            color: #333; box-shadow: 0 0 40px rgba(255,255,255,0.2); text-align: center; margin-top: 10px; z-index: 10;
        }

        /* --- GRAFIKA PSA (HLAVA V STREDE) --- */
        .game-area { height: 260px; position: relative; width: 100%; overflow: hidden; touch-action: none; }
        .dog-wrapper { height: 200px; position: absolute; width: 160px; left: 50%; top: 40%; transform: translate(-50%, -40%); transition: 0.2s; }
        
        .dog-body { 
            width: 110px; height: 80px; background: var(--dog); border-radius: 40px; 
            position: absolute; bottom: 50px; left: 25px; border: 3px solid var(--dog-d); 
            animation: breathe 3s infinite; z-index: 3; 
        }

        .dog-head { 
            width: 85px; height: 75px; background: var(--dog); border-radius: 25px; 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            border: 3px solid var(--dog-d); z-index: 5; 
        }

        .ear { width: 22px; height: 40px; background: var(--dog-d); position: absolute; border-radius: 8px; top: -5px; z-index: -1; }
        .ear.l { left: -5px; transform: rotate(-20deg); } 
        .ear.r { right: -5px; transform: rotate(20deg); }

        .eye { width: 14px; height: 14px; background: #222; border-radius: 50%; position: absolute; top: 25px; border: 2px solid var(--acc); box-shadow: 0 0 8px var(--acc); }
        .eye.l { left: 20px; } .eye.r { right: 20px; }

        .snout { width: 34px; height: 22px; background: #eef2f3; border-radius: 12px; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); border: 1px solid #ccc; }
        .nose-tip { width: 12px; height: 8px; background: #333; border-radius: 4px; position: absolute; top: 3px; left: 50%; transform: translateX(-50%); }
        .mouth { width: 18px; height: 8px; border-bottom: 2px solid #555; border-radius: 50%; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }

        .leg { width: 20px; height: 35px; background: var(--dog); border: 3px solid var(--dog-d); border-radius: 8px; position: absolute; bottom: -20px; z-index: 4; }
        .leg::after { content: ''; width: 24px; height: 10px; background: var(--dog-d); position: absolute; bottom: -3px; left: -2px; border-radius: 5px; }
        .leg.l { left: 15px; } .leg.r { right: 15px; }

        .back-leg { width: 20px; height: 40px; background: var(--dog-shadow); border: 3px solid var(--dog-d); border-radius: 8px; position: absolute; bottom: 30px; z-index: 1; }
        .back-leg::after { content: ''; width: 24px; height: 10px; background: var(--dog-d); position: absolute; bottom: -3px; left: -2px; border-radius: 5px; }
        .back-leg.l { left: 25px; transform: rotate(-5deg); } 
        .back-leg.r { right: 25px; transform: rotate(5deg); }

        .tail { width: 40px; height: 10px; background: var(--dog-d); position: absolute; left: 5px; bottom: 95px; border-radius: 10px; transform-origin: right; animation: wag 0.8s infinite alternate; z-index: 1; }
        .tail.fast { animation: wag 0.2s infinite alternate !important; }

        #bone { font-size: 45px; position: absolute; bottom: 10px; right: 10px; cursor: grab; z-index: 100; touch-action: none; user-select: none; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); }
        
        @keyframes wag { from { transform: rotate(10deg); } to { transform: rotate(50deg); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        .heart { position: absolute; font-size: 25px; pointer-events: none; animation: floatUp 1s forwards; z-index: 99; }
        @keyframes floatUp { 0% { transform: translateY(0) opacity(1); } 100% { transform: translateY(-100px) opacity(0); } }

        .speech { background: #f1f2f6; border-radius: 20px; padding: 15px; margin: 10px 0; font-weight: bold; border: 2px solid #ddd; font-size: 15px; min-height: 40px; }
        .progress-bg { background: #eee; height: 18px; border-radius: 10px; overflow: hidden; margin: 10px 0; display: none; }
        .progress-fill { background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%; height: 100%; transition: width 0.3s; }
        .btn { background: var(--acc); color: white; border: none; padding: 14px 25px; border-radius: 30px; cursor: pointer; font-weight: bold; margin: 5px; font-size: 16px; }
        .book-card { background: white; border: 2px solid #eee; border-radius: 15px; padding: 15px; margin: 8px 0; display: none; cursor: pointer; text-align: left; transition: 0.2s; }
        .book-card:active { transform: scale(0.98); background: #f0f9ff; }
        #voucher-section { display: none; background: #fff9c4; border: 3px dashed var(--gold); padding: 15px; border-radius: 25px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="game-area" id="game-area">
            <div id="bone" style="display:none;">ü¶¥</div>
            <div class="dog-wrapper">
                <div class="tail" id="tail"></div>
                <div class="back-leg l"></div><div class="back-leg r"></div>
                <div class="dog-body" id="dog-body">
                    <div class="leg l"></div><div class="leg r"></div>
                </div>
                <div class="dog-head">
                    <div class="ear l"></div><div class="ear r"></div>
                    <div class="eye l"></div><div class="eye r"></div>
                    <div class="snout">
                        <div class="nose-tip"></div>
                        <div class="mouth"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="speech" id="dialogue">Sp√∫≈°≈•am vianoƒçn√Ω modul...</div>

        <div id="p1">
            <input type="text" id="d-name" placeholder="Ako ma pomenuje≈°?" style="padding:12px; border-radius:15px; border:1px solid #ccc; width:65%; font-size:16px;">
            <button class="btn" onclick="initDog()">OK</button>
        </div>

        <div id="p2" class="progress-bg"><div id="bar" class="progress-fill"></div></div>

        <div id="p3">
            <div class="book-card" onclick="bt(1)">üèùÔ∏è <strong>Spr√°vna pƒõtka</strong></div>
            <div class="book-card" onclick="bt(2)">üêï <strong>O chlapcovi, ktor√Ω rozumel psom</strong></div>
            <div class="book-card" onclick="bt(3)">üöÄ <strong>Robopes</strong></div>
            <button class="btn" id="gift-btn" style="display:none; background:var(--gold); color:black; margin-top:15px;" onclick="showF()">üéÅ UK√Å≈Ω MI DARƒåEK</button>
        </div>

        <div id="voucher-section">
            <h3 style="margin:0;">üéÑ Darƒçek od Je≈æi≈°ka üéÑ</h3>
            <p style="font-size: 24px; font-weight: bold; margin:10px 0; color:#2c3e50;">EECHPLKMKBHH</p>
            <a href="https://www.audiolibrix.com/sk/User/Register?returnUrl=%2Fsk" target="_blank" style="text-decoration:none;">
                <button class="btn" style="width:100%; background:#e74c3c;">DO AUDIOKNI≈ΩNICE</button>
            </a>
        </div>
    </div>

    <script>
        let happy = 0; let dName = ""; let stage = 0;
        let currentUtterance = null;
        const speechDisplay = document.getElementById('dialogue');

        function talk(text, callback) {
            window.speechSynthesis.cancel();
            
            // Premenn√∫ si dr≈æ√≠me v glob√°lnom scope, aby ju garbage collector nezmazal pred koncom reƒçi
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'sk-SK';
            currentUtterance.pitch = 1.4;
            speechDisplay.innerText = text;
            
            if (callback) {
                let callbackExecuted = false;
                
                // Definujeme funkciu, ktor√° sa spust√≠ len raz
                const safeCallback = () => {
                    if (!callbackExecuted) {
                        callbackExecuted = true;
                        callback();
                    }
                };

                currentUtterance.onend = safeCallback;
                currentUtterance.onerror = safeCallback;

                // POISTKA: Ak sa niƒç nestane do 11 sek√∫nd (veta trv√° cca 8-9s), pust√≠me to ruƒçne
                setTimeout(safeCallback, 11000);
            }
            
            window.speechSynthesis.speak(currentUtterance);
        }

        function initDog() {
            const val = document.getElementById('d-name').value;
            if(!val) return;
            dName = val; stage = 1;
            document.getElementById('p1').style.display = 'none';
            document.getElementById('p2').style.display = 'block';
            document.getElementById('bone').style.display = 'block';
            talk("Ahoj Zoe! Tak≈æe ja som " + dName + ". Je≈æi≈°ko mi dal d√¥le≈æit√∫ √∫lohu, ale po tej ceste z neba som tak√Ω unaven√Ω a smutn√Ω... Rozvesel√≠≈° ma trochu? Sk√∫s ma pohladi≈• alebo mi daj kostiƒçku.");
        }

        const area = document.getElementById('game-area');
        area.addEventListener('mousemove', (e) => pet(e.clientX, e.clientY));
        area.addEventListener('touchmove', (e) => pet(e.touches[0].clientX, e.touches[0].clientY));

        function pet(x, y) {
            if(stage !== 1) return;
            const r = document.getElementById('dog-body').getBoundingClientRect();
            if(x > r.left - 10 && x < r.right + 10 && y > r.top - 20 && y < r.bottom + 40) { 
                happy += 0.5; updateBar();
                heart(x, y);
                document.getElementById('tail').classList.add('fast');
            } else { document.getElementById('tail').classList.remove('fast'); }
        }

        function heart(x, y) {
            const h = document.createElement('div');
            h.innerHTML = "‚ù§Ô∏è"; h.className = "heart";
            h.style.left = x + "px"; h.style.top = y + "px";
            document.body.appendChild(h);
            setTimeout(() => h.remove(), 1000);
        }

        const b = document.getElementById('bone'); let drag = false;
        b.onpointerdown = (e) => { drag = true; b.setPointerCapture(e.pointerId); };
        b.onpointermove = (e) => {
            if(!drag) return;
            b.style.left = (e.clientX - 25) + "px"; b.style.top = (e.clientY - 25) + "px";
            const r = document.getElementById('dog-body').getBoundingClientRect();
            if(e.clientX > r.left && e.clientX < r.right && e.clientY > r.top && e.clientY < r.bottom + 40) {
                drag = false; b.style.display = "none";
                happy += 30; updateBar();
                talk("M≈àam! T√°to je priamo z nebeskej kuchyne!");
                confetti({particleCount: 30, origin:{x:0.5, y:0.5}});
                setTimeout(() => { if(stage === 1) { b.style.display="block"; b.style.bottom="10px"; b.style.right="10px"; b.style.left="auto"; b.style.top="auto";} }, 2000);
            }
        };
        b.onpointerup = () => drag = false;

        function updateBar() {
            if(stage !== 1) return;
            document.getElementById('bar').style.width = Math.min(happy, 100) + "%";
            if(happy >= 100) {
                stage = 2;
                document.getElementById('p2').style.display = 'none';
                document.getElementById('bone').style.display = 'none';
                
                const finalIntro = "Juch√∫√∫√∫! C√≠tim sa √∫≈æasne, Zoe! Teraz ti m√¥≈æem prezradi≈•, ƒço mi Je≈æi≈°ko povedal. Nechal tu pre teba darƒçek v podobe audiokn√≠h! Chce≈° ich vidie≈•? Pozri na tieto rozpr√°vky. Klikni na nejak√∫ a ja ti o nej nieƒço poviem.";
                
                talk(finalIntro, function() {
                    document.querySelectorAll('.book-card').forEach(c => c.style.display = 'block');
                });
            }
        }

        function bt(id) {
            confetti({particleCount: 20});
            if(id === 1) talk("Spr√°vna pƒõtka je o dobrodru≈æstve na ostrove. Je tam aj pes Tim, skoro tak√Ω ≈°ikovn√Ω ako ja!");
            if(id === 2) talk("Tento pr√≠beh je o chlapcovi, ktor√Ω n√°m psom rozumie √∫plne v≈°etko. Skoro ako ty!");
            if(id === 3) talk("M√¥j bratranec Robopes! Je z kovu ako ja a za≈æ√≠va poriadne bl√°zniv√© veci.");
            document.getElementById('gift-btn').style.display = 'block';
        }

        function showF() {
            document.getElementById('p3').style.display = 'none';
            document.getElementById('voucher-section').style.display = 'block';
            talk("≈†≈•astn√© a vesel√© Vianoce, Zoe! Tu m√°≈° svoj k√≥d od Je≈æi≈°ka.");
            confetti({particleCount: 150, spread: 70, origin: {y: 0.6}});
        }

        window.onload = () => {
            setTimeout(() => talk("Ahoj Zoe! Je≈æi≈°ko mi o tebe rozpr√°val a ƒç√≠tal tvoj list. Poslal ma za tebou, aby som ti odovzdal nieƒço ≈°peci√°lne. Ale najsk√¥r... ako ma pomenuje≈°?"), 1000);
        };
    </script>
</body>
</html>
